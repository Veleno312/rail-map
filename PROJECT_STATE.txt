World-Scale Transport & Economy Simulator - Current State and Next Steps

Current state (high level)
- Two primary modes: Population and Industry. Tabs: Network, Transport, Economy, Dynamics.
- Transport tab contains track build + line edit modes; time stops while in build mode.
- Lines follow built tracks only; line diagram uses a zig-zag layout with shared-stop badges.
- Dynamic flow overlay exists and is tab-aware: passengers in Population, goods in Industry.
- Industry data uses macro production/consumption with per-node breakdown and icons.
- Economy includes network KPIs, score, country unlocks, and a local investment system.
- Investments: companies at country + top clusters, shares, monthly dividends, needs boost.
- Deterministic sim core is partially separated; clock-driven service runs.
- OSM/ADIF import pipeline exists (local JSON and optional overpass).

Key additions already implemented recently
- Line numbers editable; used across UI and connection badges.
- Active line status filtering by mode.
- Goods demand split (rail vs other) shown in Industry/Dynamics.
- Investment panel added and surfaced in Industry and Economy.

Known issues / risks
- Data freshness and coverage for tracks/production varies by dataset.
- OSM imports can fail or be slow depending on network/API.
- Some UI strings and icons still placeholder or inconsistent.

Future additions (priority order)
1) Scientific model upgrades
   - Explicit unit docs + parameter tables for production, demand, and routing.
   - Replace placeholder demand/price constants with calibrated sources.
   - Add validation harness + golden scenarios + regression tests.
2) Production/industry realism
   - Per-item supply/need per city/cluster with real datasets.
   - Mode split based on cost/time and capacity (logit choice).
   - Inventory/shortage effects on output (bounded, stable feedback).
3) Routing and optimizer
   - Multi-criteria routing (time/cost/capacity) with no station repeats.
   - Optimizer that builds several long lines and respects hub connectivity.
4) World scale / data
   - Tile loading + multi-resolution nodes and caching.
   - Official track datasets (non-OSM) with licensing metadata.
5) Gameplay
   - Contracts, missions, events, and CEO progression.
   - Competition mode and intermodal extensions (bus/tram/air).
6) UX/visuals
   - Clear tab-specific overlays and legends.
   - More polished line diagram scaling for very long lines.
   - Loading / status UI for large data imports.

============================================================
Specs to follow up (authoritative project vision)
============================================================

PROJECT: World-Scale Transport & Economy Simulator (Realistic, Scientific, Publishable, Playable)

GOAL
Build a browser-based simulator/game where the player is a transport-company CEO (initially rail). The system must be:
1) Casual & engaging (missions, visuals, events, CEO progression)
2) Scientifically defensible (explicit models, units, calibration/validation, reproducible runs)
3) World-scale (tile loading, progressive expansion, multi-resolution)
4) Deterministic & reproducible (datasetVersion + modelVersion + schemaVersion + seed)
5) Data-driven from official/reputable sources with explicit licensing and data cards.

NON-NEGOTIABLE SCIENTIFIC RULES
- Sim core must be pure, deterministic functions (no DOM, no rendering).
- Everything has units; no magic constants without meaning and documentation.
- Every run is reproducible: datasetVersion + modelVersion + schemaVersion + seed.
- Exports: JSON/CSV report with metadata and units.
- Validation harness exists: golden scenarios + regression tests + sanity checks.
- Models must be explicitly stated (e.g., gravity demand, logit choice, routing/assignment).
- Prefer conservative, stable feedback loops (avoid runaway growth).

DESIGN PRINCIPLES
- World scale via tiles + indexes + caching + unload/summarize.
- Multi-resolution nodes (L0/L1/L2) + clustering for dense areas.
- Separate infrastructure graph (edges) from services (timetables/lines).
- Terrain matters: slope/elevation influences cost (tunnels/bridges).
- Interactions must respect constraints: capacity, schedules, costs, construction time.

CORE GAME LOOP
Observe demand & bottlenecks -> build/upgrade lines & schedules -> operate services -> earn revenue & reputation -> unlock new markets/countries/modes.

FEATURE SET (must be realistic)
- Rail company CEO: capex/opex, revenue, contracts, reputation
- Timetables + coordination: splitting/joining trains, transfers
- Population dynamics: migration response to accessibility (slow + bounded)
- Economic growth: freight movement improves productivity proxies (bounded)
- Competition (optional mode): bidding, outpricing, service rivalry
- News/comments: events impact demand/cost/regulation/reputation
- Multi-modal unlocks: bus/tram/air later, via a common mode interface
- Online access: free web distribution; minimal ad/perks, but sim integrity remains

IMPLEMENTATION ORDER (do not skip)
1) Foundations: seed RNG, validators, sim core extraction, save/load migrations, exports, golden tests
2) Data contracts: scenario pack schema + validation tools + manifest + caching
3) World scale: tile scheme + loader + start-anywhere + expansion + unload summarization
4) Multi-resolution: clustering/aggregation by zoom + active sim set
5) Sim core v1: passenger demand + routing + capacity + revenue/cost
6) Scientific harness: calibration + validation metrics + report generator
7) Freight + economy + population feedback loops (conservative)
8) Gameplay layers: contracts, unlocking, competition, news, missions
9) New modes: bus/tram/air with shared abstractions + intermodal transfers

HOW YOU (THE AI) SHOULD WORK
- Always ask: “Is this deterministic? Does it have units? Can it be validated?”
- When proposing a model, provide: equations/logic, parameters, units, expected ranges, and validation plan.
- Prefer small, testable increments with acceptance criteria and regression tests.
- Keep UI separate from sim core. Never mix rendering with model updates.
- Output should be copy-pastable: file-level changes, function signatures, schemas, and test cases.

ACCEPTANCE CRITERIA FOR ANY CHANGE
- Deterministic given seed
- Validated by schema/state validator
- Exportable in report
- Doesn’t break golden scenarios
- Has documented units and parameters

USEFUL INFORMATION
- Can use Metrodreamin' as an UI base for the display as it is very well done (preferred)
- Should use all data from official sources.

============================================================
README.md (verbatim reference)
============================================================

# Ultimate Mega-Roadmap ƒ?" World-Scale, Realistic, Playable, Publishable
A giant checklist with dependencies + optional implementation paths.
Goal: a simulator that is both:
- **Casual & engaging** (missions, visuals, events, ƒ?otoyƒ?? satisfaction)
- **Serious & publishable** (calibrated models, differential equations, reproducible datasets)
- **World-scale** (start anywhere; progressive expansion; tiles; multi-resolution)

Legend:
- [ID] Task ID
- (S/M/L) small/medium/large
- Depends on: [ID], [ID]
-  directly supports publishable/math-tool objective
- Optional path = alternative implementation method

============================================================
0) NORTH STAR (keep you aligned)
============================================================
- Reproducible runs: datasetVersion + modelVersion + seed pinned
- Units everywhere; never magic numbers without documented meaning 
- Multi-resolution + tiles = world scale without loading Earth at once
- Pure sim core, separate from UI rendering
- Player loop: problem "action" feedback (alerts, KPIs, visuals)

============================================================
1) FOUNDATIONS: stability, structure, reproducibility
============================================================

[X] [1.1] Error banner instead of blank page (S)
Depends on: none

[X] [1.2] Debug drawer with last error + last sim stats (S)
Depends on: [1.1]

[X] [1.3] State validator (S)
- check nodes/tracks/lines; warnings not crashes
Depends on: [1.2] (optional)

[X] [1.4] Deterministic RNG + seed UI (S) ĐY""
Depends on: none

[X] [1.5] Version stamps in state/saves: dataset/model/schema (S) ĐY""
Depends on: none

[X] [1.6] Sim core extraction (`sim_core.js` pure functions) (M) ĐY""
Depends on: [1.3] recommended

[X] [1.7] Render isolation (`render_network`, `render_overlay`) (M)
Depends on: none (easier after [1.6])

[X] [1.8] Save/load with migrations (M) ĐY""
Depends on: [1.5]

[X] [1.9] Golden test scenarios (S)
Depends on: [1.6] recommended

[X] [1.10] Regression tests runner (M) ĐY""
Depends on: [1.9], [1.6]

[X] [1.11] Model report export (JSON/CSV) (S) ĐY""
Depends on: [1.5], [1.6]

============================================================
2) SCENARIOS & DATASETS: offline / hybrid / online ĐY""
============================================================

[X] [2.1] Scenario pack format spec (S) ĐY""
- nodes, edges, services, zones, industry, elevation, metadata, license
Depends on: none

[X] [2.2] Scenario loader for packs (S)
Depends on: [1.3]

[X] [2.3] Scenario menu + new game flow (S)
Depends on: [2.2]

[X] [2.4] Offline build pipeline skeleton (`tools/`) (M) ĐY""
Depends on: none

[X] [2.5] Pack validation tool (schema + sanity) (M) ĐY""
Depends on: [2.1], [2.4]

[X] [2.6] Hybrid updater: manifest.json (S) ĐY""
Depends on: [1.5], [2.2]

[X] [2.7] Cached datasets via IndexedDB (M) ĐY""
Depends on: [2.6]

[X] [2.8] Save pinned to datasetVersion (S) ĐY""
Depends on: [1.5], [2.2]

[X] [2.9] Online mode toggle (S)
Depends on: [2.6] or [2.2]

[2.10] Online dataset builder service (L) (Optional)
Depends on: [2.4], [2.6]

[2.11] Live updates overlay layer (M/L) (Optional online)
Depends on: [2.10]

============================================================
3) WORLD SCALE CORE: tiles + indexes + progressive expansion ĐY""
============================================================

---- W-INDEX & TILE SCHEME ----
[X] [3.1] Tile ID scheme + neighbor definition (S)
Depends on: none

[3.2] Tile index format (tiles.json: bbox, files, sizes, neighbors) (S)
Depends on: [3.1]

[3.3] Country index format (countries.json: ISO, bbox, default starts, tiles) (S)
Depends on: [3.2]

---- TILE LOADER MVP ----
[3.4] Loader: load tiles into state (merge/dedupe) (M)
- `loadWorldTiles({version, tileIds})`
Depends on: [2.2], [1.3] recommended

[3.5] Start-anywhere UI (M)
- pick country/city; loads required tiles
Depends on: [3.3], [3.4]

[3.6] Save stores loaded tile IDs (S) ĐY""
Depends on: [2.8], [3.4]

---- PROGRESSIVE EXPANSION ----
[3.7] Load neighbor tiles on demand (M)
Depends on: [3.4]

[3.8] Expand-to-neighbor-country mechanic (S/M)
Depends on: [3.3], [3.7]

[3.9] Memory guardrails: max tiles/nodes; prompt to unload (S)
Depends on: [3.7]

[3.10] Tile unload + summarization (L)
- keep aggregated stats; drop geometry
Depends on: [3.9], multi-resolution [4.*] recommended

============================================================
4) ƒ?oEVERY TOWN ƒ%¾ 500 POPƒ?? + MULTI-RESOLUTION SIM ĐY""
============================================================

[4.1] Settlement threshold config (S)
Depends on: [2.2]

[4.2] Multi-resolution node sets: L0/L1/L2 (M) ĐY""
Depends on: [1.6] recommended

[4.3] Dynamic aggregation by zoom/selection (M) ĐY""
Depends on: [4.2]

[4.4] OD caps + sampling policy (M) ĐY""
Depends on: [4.3]

[4.5] Active simulation set definition (S)
- active tiles + selected region = active nodes
Depends on: [1.6] recommended

[4.6] Precompute neighbor lists offline (M)
Depends on: [2.4]

[4.7] Dataset size & compile-time budget doc (S) ĐY""
Depends on: none

[4.8] Runtime profiling HUD (S)
Depends on: [1.2]

============================================================
5) WORLD DATA BUILD PIPELINE (offline, scalable) ĐY""
============================================================

[5.1] Tile the world builder (M)
Depends on: [3.1]

[5.2] OSM ƒÅ' rail edges per tile (L)
Depends on: [5.1]

[5.3] Population/settlements ƒ%¾500 ƒÅ' nodes per tile (M/L)
Depends on: [5.1]

[5.4] GTFS ƒÅ' services per tile (L)
- where available; else empty
Depends on: [5.3], [5.1]

[5.5] Zones per tile (M)
Depends on: [5.1]

[5.6] Industry proxies per tile (M/L)
Depends on: [5.1]

[5.7] Elevation samples per tile (optional) (M/L)
Depends on: [5.1]

[5.8] Build indexes: tiles.json + countries.json (M)
Depends on: [5.2ƒ?"5.5]

[5.9] Compress + size report (S)
Depends on: [5.8]

[5.10] Spain ƒ?ostarter tilesƒ?? first (M)
Depends on: [5.1ƒ?"5.5] but can be done as pilot

[5.11] Europe pack next (L)
Depends on: [5.10]

[5.12] World pack later (L)
Depends on: [5.11]

============================================================
6) BASE NETWORKS & SERVICES (Spain ƒÅ' Europe ƒÅ' World)
============================================================

[6.1] Spain base services from GTFS (M)
Depends on: [2.4], [2.2]

[6.2] Europe infrastructure base (L)
Depends on: [5.2]

[6.3] Snap services onto infrastructure graph (M/L)
Depends on: [6.1], [6.2]

[6.4] Cross-border service continuity (M)
Depends on: [6.3], [3.7]

============================================================
7) TRACK REALISM: terrain + tunnels/bridges + gradients ĐY""
============================================================

[7.1] Elevation source A (offline tiles) (M)
Depends on: [5.7]

[7.2] Elevation source B (online fetch+cache) (M) Optional
Depends on: [2.7] or online [2.9]

[7.3] Slope estimator (S)
Depends on: [7.1] or [7.2]

[7.4] Track cost model v1 (S) ĐY""
Depends on: [7.3]

[7.5] Track type: surface / tunnel / bridge (S)
Depends on: [7.4]

[7.6] Structure time multipliers (S)
Depends on: [7.5]

[7.7] Visual styling by type (S)
Depends on: [7.5]

[7.8] Auto-suggest tunnel/bridge (M)
Depends on: [7.5]

[7.9] Grade limits by technology/mode (M)
Depends on: [7.4], mode framework [10.1]

============================================================
8) CONSTRUCTION & TIME (projects feel real)
============================================================

[8.1] Construction queue (S/M)
Depends on: [1.3]

[8.2] Projects take months/years; show ETA (S)
Depends on: [8.1]

[8.3] Tunnel/bridge longer construction (S)
Depends on: [7.6], [8.1]

[8.4] Land acquisition/urban penalty (M)
Depends on: [7.4]

============================================================
9) OPERATIONS METRICS: measurable constraints ĐY""
============================================================

[9.1] Station train moves/day (S)
Depends on: lines+freq exist

[9.2] Platform throughput capacity (S)
Depends on: [9.1]

[9.3] Utilization display + alerts (S)
Depends on: [9.2]

[9.4] Delays if utilization>1 (M)
Depends on: [9.3]

[9.5] Delay propagation (M)
Depends on: [9.4]

[9.6] Dwell model (M)
Depends on: boardings estimation [12.6] or demand model [12.*]

============================================================
10) MULTIMODAL FOUNDATION (bus/metro/tram/ferry/air)
============================================================

[10.1] Mode field on lines (S)
Depends on: none

[10.2] Mode defaults: speed/capacity/cost/km (S)
Depends on: [10.1]

[10.3] Transfer penalty model (S)
Depends on: [10.1]

[10.4] Interchanges (M)
Depends on: [10.3]

[10.5] Airports/ports special nodes (M)
Depends on: [10.4] recommended

============================================================
11) PASSENGERS VS CARGO (separate layers + filters) ĐY""
============================================================

[11.1] Demand separation in state (S)
Depends on: none

[11.2] Passenger/cargo overlay filters (S)
Depends on: [11.1]

[11.3] Cargo terminals model (M)
Depends on: [11.1], nodes/industry [5.6] recommended

============================================================
12) DEMAND, ASSIGNMENT, CAPACITY (transport modeling) ĐY""
============================================================

[12.1] Generalized cost graph (S/M) ĐY""
Depends on: [1.6] recommended

[12.2] Passenger demand model v1 (M) ĐY""
Depends on: [12.1], multi-res [4.*] for world

[12.3] Cargo demand model v1 (M) ĐY""
Depends on: [12.1], [5.6], [11.3]

[12.4] Assignment v1 (shortest path) (M) ĐY""
Depends on: [12.2]/[12.3]

[12.5] Capacity constraints + spill (M) ĐY""
Depends on: [12.4]

[12.6] Boardings/alightings estimation (M)
Depends on: [12.5]

[12.7] Stochastic route choice (M/L) ĐY""
Depends on: [12.4]

[12.8] Time-of-day demand + peaks (M)
Depends on: timetable [13.*], [12.2]

============================================================
13) TIMETABLES & SERVICE PATTERNS
============================================================

[13.1] Frequency editor UI (S)
Depends on: lines exist

[13.2] Service span + peak/off-peak profiles (M)
Depends on: [13.1]

[13.3] Express/local skip-stop patterns (M)
Depends on: [13.2]

[13.4] Timed transfers (M)
Depends on: [10.4], [13.2]

============================================================
14) ECONOMICS: serious-but-readable operator math ĐY""
============================================================

[14.1] Capex vs opex separation (S)
Depends on: none

[14.2] Passenger revenue = pax-km * fare/km (M) ĐY""
Depends on: [12.5]

[14.3] Cargo revenue = tonne-km * rate (M) ĐY""
Depends on: [12.5]

[14.4] Costs per train-km by mode (M) ĐY""
Depends on: [10.2]

[14.5] Station ops costs + retail tied to footfall (M)
Depends on: [12.6], [14.5]

[14.6] Subsidies/PSO contracts (M)
Depends on: [14.2], [14.4]

============================================================
15) STATIONS: realism + upgrades that actually do things
============================================================

[15.1] Station types (S)
Depends on: none

[15.2] Concourse capacity + crowding (M)
Depends on: [12.6]

[15.3] Amenities reduce crowding; platforms increase throughput (M)
Depends on: [15.2], [9.2]

[15.4] Retail revenue tied to footfall (M)
Depends on: [12.6], [14.5]

[15.5] Freight terminals capacity (M)
Depends on: [11.3], [12.5]

============================================================
16) EVENTS SYSTEM (Plague.inc vibe but reproducible) ĐY""
============================================================

[16.1] Event framework: type, region, severity, duration (S) ĐY""
Depends on: [1.4], [1.6 recommended]

[16.2] Seeded random event generator (S) ĐY""
Depends on: [16.1]

[16.3] Weather events: speed reductions, cancellations (M)
Depends on: [16.1], [10.2]

[16.4] Illness/pandemic events: demand shocks (M) ĐY""
Depends on: [16.1], [12.2]

[16.5] Disasters: closures, infrastructure damage (M)
Depends on: [16.1], [7.5], construction [8.1]

[16.6] Politics/regulation: subsidies, strikes, borders (M)
Depends on: [16.1], [14.6], [3.7]

[16.7] News timeline UI + event cards (S/M)
Depends on: [16.1], KPI dashboard [18.1]

============================================================
17) DIFFERENTIAL EQUATIONS / MACRO DYNAMICS (publishable) ĐY""
============================================================

[17.1] Macro variables per region: P,G,I,H (S) ĐY""
Depends on: multi-res regions [4.2], sim core [1.6] recommended

[17.2] Accessibility index A_i from travel times & service (S/M) ĐY""
Depends on: [12.1]

[17.3] ODE solver module (RK4 / stable integrator) (M) ĐY""
Depends on: [17.1]

[17.4] Population dynamics equation dP/dt (M) ĐY""
Depends on: [17.2], [17.3]

[17.5] GDP/industry dynamics dG/dt, dI/dt (M) ĐY""
Depends on: [17.2], [17.3]

[17.6] Coupling: macro ƒÅ' demand & demand ƒÅ' macro (M) ĐY""
Depends on: [12.2][12.3], [17.4][17.5]

[17.7] Stability ƒ?ofoolproofƒ?? constraints (M) ĐY""
- non-negativity, bounded growth, sanity caps
Depends on: [17.3]

[17.8] Sensitivity analysis runner (L) ĐY""
Depends on: [1.11], [17.7]

[17.9] Paper experiment runner (headless) (M/L) ĐY""
Depends on: [1.10], [17.8]

============================================================
18) OPTIMIZERS + SCORING (smart buttons + ƒ?omost effective lineƒ??)
============================================================

[18.1] KPI dashboard (S)
Depends on: any metrics (grows over time)

[18.2] Score function (S)
Depends on: [18.1]

[18.3] Suggest best new line (M)
Depends on: unmet demand [12.5], [18.1]

[18.4] Suggest best frequency upgrades (S/M)
Depends on: [12.5], [18.1]

[18.5] Suggest best station upgrades (S/M)
Depends on: [9.3], [15.2]

[18.6] Advanced optimizer (GA/annealing) (L)
Depends on: [18.3ƒ?"18.5]

[18.7] ƒ?oMost effective lineƒ?? ranking (S/M)
Depends on: [18.1], [18.2], revenue/cost [14.*]

============================================================
19) UX FOR CASUAL + PRO TOOL MODES
============================================================

[19.1] Toolbar + Inspector to replace tab clutter (M)
Depends on: [1.7]

[19.2] Hotkeys (S)
Depends on: none

[19.3] Casual mode preset (S)
Depends on: [18.2] optional

[19.4] Pro mode preset + exports + calibration UI (M) ĐY""
Depends on: [1.11], [17.*]

[19.5] Tutorials + missions (M)
Depends on: scenario system [2.3], events [16.*] optional

============================================================
20) VISUALS & FEEL (engagement)
============================================================

[20.1] Station crowd dots (M)
Depends on: [15.2] or [12.6]

[20.2] Cargo particles (M)
Depends on: [11.3], [12.5]

[20.3] Heatmaps (M)
Depends on: [18.1]

[20.4] Charts/trends (M)
Depends on: [18.1], [1.11]

[20.5] Sound/ambience (optional) (M)
Depends on: none

============================================================
21) LINE TOOLS (your requested ƒ?onice touchesƒ??)
============================================================

[21.1] Line color changing tool (S)
Depends on: lines exist

[21.2] Line rename + icon tool (S)
Depends on: lines exist

[21.3] Line service class (HSR/Regional/Freight/etc.) (S/M)
Depends on: [10.1] or simple enums

============================================================
22) RECOMMENDED START (big vision, practical steps)
============================================================

Start with a ƒ?oPublishable Spineƒ?? + ƒ?oWorld-loader spineƒ??:

A) Publishable spine (math + reproducibility):
1) [X] [1.4] Seed + deterministic runs ĐY""
2) [X] [1.5] Version stamps ĐY""
3) [16.1] Event framework (seeded) ĐY""
4) [17.3] ODE solver module ĐY""
5) [17.1][17.2] Macro variables + accessibility ĐY""
6) [X] [1.11] Model export ĐY""

B) World spine (scale):
7) [3.1ƒ?"3.5] Tiles + indexes + start-anywhere loader
8) [4.2ƒ?"4.4] Multi-resolution + aggregation for performance

C) Quick delight (anytime):
- [21.1] line color tool
- [20.1] station crowds
- [18.1] KPI dashboard

===========================================================
23) Optimizer new
===========================================================

A) Make the optimizer work between two places and get the most optimal route
